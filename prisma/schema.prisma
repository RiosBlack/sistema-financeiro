// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  password      String?
  image         String?
  roleId        String?
  role          Role?     @relation(fields: [roleId], references: [id])
  accounts      Account[]
  sessions      Session[]

  // Relacionamentos financeiros
  bankAccounts        UserBankAccount[]
  cards               Card[]
  transactions        Transaction[]
  userGoals           UserGoal[]
  createdCategories   Category[]        @relation("CategoryCreator")
  createdBankAccounts BankAccount[]     @relation("BankAccountCreator")
  createdGoals        Goal[]            @relation("GoalCreator")
  budgets             Budget[]

  // Relacionamentos de família
  createdFamilies     Family[]           @relation("FamilyCreator")
  familyMembers       FamilyMember[]
  invitationsSent     FamilyInvitation[] @relation("InvitationsSent")
  invitationsReceived FamilyInvitation[] @relation("InvitationsReceived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          String @id @default(cuid())
  name        String @unique
  description String
  users       User[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== MODELOS FINANCEIROS ====================

// Conta Bancária (pode ser individual ou conjunta)
model BankAccount {
  id             String      @id @default(cuid())
  name           String
  institution    String
  type           AccountType @default(CHECKING)
  initialBalance Decimal     @default(0) @db.Decimal(10, 2)
  currentBalance Decimal     @default(0) @db.Decimal(10, 2)
  color          String? // Para identificação visual
  isActive       Boolean     @default(true)
  isShared       Boolean     @default(false) // Compartilhado com família

  createdById String
  createdBy   User   @relation("BankAccountCreator", fields: [createdById], references: [id], onDelete: Cascade)

  // Relacionamentos
  users        UserBankAccount[]
  cards        Card[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
}

// Relacionamento N-N entre Usuário e Conta (para contas conjuntas)
model UserBankAccount {
  id            String      @id @default(cuid())
  userId        String
  bankAccountId String
  role          AccountRole @default(MEMBER) // OWNER ou MEMBER

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, bankAccountId])
  @@index([userId])
  @@index([bankAccountId])
}

// Cartão de Crédito/Débito (sempre individual)
model Card {
  id         String     @id @default(cuid())
  name       String
  lastDigits String // Últimos 4 dígitos
  type       CardType   @default(CREDIT)
  brand      CardBrand?
  limit      Decimal?   @db.Decimal(10, 2) // Limite para cartão de crédito
  dueDay     Int? // Dia do vencimento da fatura
  closingDay Int? // Dia do fechamento da fatura
  color      String?
  isActive   Boolean    @default(true)
  isShared   Boolean    @default(false) // Compartilhado com família

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bankAccountId String? // Conta vinculada (para débito automático)
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([bankAccountId])
}

// Categoria de Transação
model Category {
  id        String          @id @default(cuid())
  name      String
  icon      String?
  color     String?
  type      TransactionType // INCOME ou EXPENSE
  isDefault Boolean         @default(false) // Categorias padrão do sistema
  isShared  Boolean         @default(false) // Compartilhado com família

  createdById String?
  createdBy   User?   @relation("CategoryCreator", fields: [createdById], references: [id], onDelete: Cascade)

  transactions Transaction[]
  budgets      Budget[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([type])
}

// Transação (cada usuário tem seu registro)
model Transaction {
  id          String          @id @default(cuid())
  description String
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  date        DateTime        @default(now())

  // Dados da transação
  isPaid             Boolean        @default(false)
  isRecurring        Boolean        @default(false)
  recurringType      RecurringType?
  installments       Int?           @default(1)
  currentInstallment Int?           @default(1)
  isShared           Boolean        @default(false) // Compartilhado com família

  // Relacionamentos
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  bankAccountId String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)

  cardId String?
  card   Card?   @relation(fields: [cardId], references: [id], onDelete: SetNull)

  // Transação pai (para parcelamentos)
  parentTransactionId String?
  parentTransaction   Transaction?  @relation("TransactionInstallments", fields: [parentTransactionId], references: [id], onDelete: Cascade)
  childTransactions   Transaction[] @relation("TransactionInstallments")

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([categoryId])
  @@index([bankAccountId])
  @@index([cardId])
  @@index([date])
  @@index([type])
  @@index([isPaid])
}

// Meta Financeira (pode ser individual ou conjunta)
model Goal {
  id            String    @id @default(cuid())
  name          String
  description   String?   @db.Text
  targetAmount  Decimal   @db.Decimal(10, 2)
  currentAmount Decimal   @default(0) @db.Decimal(10, 2)
  deadline      DateTime?
  icon          String?
  color         String?
  isCompleted   Boolean   @default(false)

  createdById String
  createdBy   User   @relation("GoalCreator", fields: [createdById], references: [id], onDelete: Cascade)

  users UserGoal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([isCompleted])
}

// Relacionamento N-N entre Usuário e Meta (para metas conjuntas)
model UserGoal {
  id           String  @id @default(cuid())
  userId       String
  goalId       String
  contribution Decimal @default(0) @db.Decimal(10, 2)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, goalId])
  @@index([userId])
  @@index([goalId])
}

// Orçamento por Categoria
model Budget {
  id     String  @id @default(cuid())
  amount Decimal @db.Decimal(10, 2)
  month  Int // 1-12
  year   Int

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, categoryId, month, year])
  @@index([userId])
  @@index([categoryId])
  @@index([month, year])
}

// ==================== MODELOS DE FAMÍLIA ====================

// Família - Grupo familiar para compartilhamento de dados
model Family {
  id          String   @id @default(cuid())
  name        String
  createdById String
  createdBy   User     @relation("FamilyCreator", fields: [createdById], references: [id], onDelete: Cascade)

  members     FamilyMember[]
  invitations FamilyInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
}

// Membro da Família
model FamilyMember {
  id       String     @id @default(cuid())
  familyId String
  userId   String
  role     FamilyRole @default(MEMBER)

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([familyId, userId])
  @@index([familyId])
  @@index([userId])
}

// Convite para Família
model FamilyInvitation {
  id         String           @id @default(cuid())
  familyId   String
  invitedId  String
  invitedBy  String
  status     InvitationStatus @default(PENDING)

  family  Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invited User   @relation("InvitationsReceived", fields: [invitedId], references: [id], onDelete: Cascade)
  inviter User   @relation("InvitationsSent", fields: [invitedBy], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  @@unique([familyId, invitedId])
  @@index([familyId])
  @@index([invitedId])
  @@index([invitedBy])
  @@index([status])
}

// ==================== ENUMS ====================

enum AccountType {
  CHECKING // Conta corrente
  SAVINGS // Poupança
  INVESTMENT // Investimento
  CASH // Dinheiro
  OTHER // Outro
}

enum AccountRole {
  OWNER // Proprietário da conta
  MEMBER // Membro com acesso
}

enum CardType {
  CREDIT // Crédito
  DEBIT // Débito
}

enum CardBrand {
  VISA
  MASTERCARD
  ELO
  AMEX
  HIPERCARD
  OTHER
}

enum TransactionType {
  INCOME // Receita
  EXPENSE // Despesa
}

enum RecurringType {
  DAILY // Diário
  WEEKLY // Semanal
  MONTHLY // Mensal
  YEARLY // Anual
}

enum FamilyRole {
  OWNER // Criador da família, pode remover membros
  MEMBER // Membro da família, apenas visualização
}

enum InvitationStatus {
  PENDING // Aguardando resposta
  ACCEPTED // Aceito
  REJECTED // Rejeitado
}
